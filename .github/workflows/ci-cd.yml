# name: ESMS CI/CD Pipeline

# on:
#   push:
#     branches: [ main, develop ]
#   pull_request:
#     branches: [ main ]

# env:
#   CARGO_TERM_COLOR: always

# jobs:
#   test-backend:
#     name: Test Rust Backend
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Rust
#       uses: actions-rs/toolchain@v1
#       with:
#         toolchain: stable
#         override: true
#         components: rustfmt, clippy

#     - name: Cache cargo dependencies
#       uses: actions/cache@v3
#       with:
#         path: |
#           ~/.cargo/bin/
#           ~/.cargo/registry/index/
#           ~/.cargo/registry/cache/
#           ~/.cargo/git/db/
#           backend/target/
#         key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.lock') }}

#     - name: Run cargo check
#       working-directory: ./backend
#       run: cargo check --verbose

#     - name: Run cargo clippy
#       working-directory: ./backend
#       run: cargo clippy -- -D warnings

#     - name: Run cargo fmt
#       working-directory: ./backend
#       run: cargo fmt -- --check

#   build-and-test:
#     name: Build and Test Full Stack
#     runs-on: ubuntu-latest
#     needs: test-backend
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v2

#     - name: Build backend image
#       uses: docker/build-push-action@v4
#       with:
#         context: ./backend
#         file: ./backend/Dockerfile
#         push: false
#         tags: esms-backend:test
#         cache-from: type=gha
#         cache-to: type=gha,mode=max

#     - name: Build frontend image
#       uses: docker/build-push-action@v4
#       with:
#         context: ./frontend
#         file: ./frontend/Dockerfile
#         push: false
#         tags: esms-frontend:test

#     - name: Start services with Docker Compose
#       run: |
#         docker-compose up -d
#         sleep 10

#     - name: Wait for backend to be ready
#       run: |
#         timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done'

#     - name: Test backend health endpoint
#       run: |
#         response=$(curl -s http://localhost:8080/health)
#         echo "Health response: $response"
#         echo $response | jq -e '.status == "healthy"'

#     - name: Test realtime API endpoint
#       run: |
#         response=$(curl -s http://localhost:8080/api/realtime)
#         echo "Realtime API response: $response"
#         echo $response | jq -e 'type == "array"'

#     - name: Test FHIR observation endpoint
#       run: |
#         sleep 5
#         response=$(curl -s http://localhost:8080/api/fhir/observation)
#         echo "FHIR response: $response"
#         echo $response | jq -e '.resourceType == "Observation" or .error != null'

#     - name: Test frontend accessibility
#       run: |
#         curl -f http://localhost:3000 || exit 1

#     - name: Display container logs on failure
#       if: failure()
#       run: |
#         echo "=== Backend Logs ==="
#         docker-compose logs backend
#         echo "=== Frontend Logs ==="
#         docker-compose logs frontend
#         echo "=== Redis Logs ==="
#         docker-compose logs redis
#         echo "=== MySQL Logs ==="
#         docker-compose logs mysql

#     - name: Stop services
#       if: always()
#       run: docker-compose down -v

#   deploy-codespaces:
#     name: Verify Codespaces Compatibility
#     runs-on: ubuntu-latest
#     needs: build-and-test
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Verify devcontainer configuration
#       run: |
#         if [ -f .devcontainer/devcontainer.json ]; then
#           echo "âœ… devcontainer.json found"
#           cat .devcontainer/devcontainer.json
#         else
#           echo "âš ï¸ devcontainer.json not found - creating basic config"
#           mkdir -p .devcontainer
#           echo '{
#             "name": "ESMS Development",
#             "dockerComposeFile": "../docker-compose.yml",
#             "service": "backend",
#             "workspaceFolder": "/workspace",
#             "forwardPorts": [8080, 3000, 6379, 3306],
#             "postCreateCommand": "echo ESMS environment ready"
#           }' > .devcontainer/devcontainer.json
#         fi

#     - name: Validate docker-compose for Codespaces
#       run: |
#         docker-compose config > /dev/null
#         echo "âœ… docker-compose.yml is valid"

#     - name: Check simulated mode compatibility
#       run: |
#         echo "âœ… Backend supports simulated sensor mode for cloud deployment"
#         grep -q "simulate_sensor_data" backend/src/main.rs && echo "âœ… Simulation code present"

#   security-scan:
#     name: Security Scan
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Run Trivy vulnerability scanner
#       uses: aquasecurity/trivy-action@master
#       with:
#         scan-type: 'fs'
#         scan-ref: '.'
#         format: 'sarif'
#         output: 'trivy-results.sarif'

#     - name: Upload Trivy results to GitHub Security
#       uses: github/codeql-action/upload-sarif@v2
#       if: always()
#       with:
#         sarif_file: 'trivy-results.sarif'


# name: ESMS CI/CD Pipeline

# on:
#   push:
#     branches: [ main, develop ]
#   pull_request:
#     branches: [ main ]

# env:
#   CARGO_TERM_COLOR: always

# jobs:
#   test-backend:
#     name: Test Rust Backend
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Setup Rust
#       uses: dtolnay/rust-toolchain@stable
#       with:
#         toolchain: nightly

#     - name: Cache cargo dependencies
#       uses: actions/cache@v4
#       with:
#         path: |
#           ~/.cargo/bin/
#           ~/.cargo/registry/index/
#           ~/.cargo/registry/cache/
#           ~/.cargo/git/db/
#           backend/target/
#         key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.toml') }}

#     - name: Build backend
#       working-directory: ./backend
#       run: cargo build --verbose

#     - name: Check backend compiles
#       working-directory: ./backend
#       run: cargo check --verbose

#   build-and-test:
#     name: Build and Test Full Stack
#     runs-on: ubuntu-latest
#     needs: test-backend
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v3

#     - name: Build backend image
#       uses: docker/build-push-action@v5
#       with:
#         context: ./backend
#         file: ./backend/Dockerfile
#         push: false
#         tags: esms-backend:test
#         cache-from: type=gha
#         cache-to: type=gha,mode=max

#     - name: Build frontend image
#       uses: docker/build-push-action@v5
#       with:
#         context: ./frontend
#         file: ./frontend/Dockerfile
#         push: false
#         tags: esms-frontend:test

#     - name: Start services with Docker Compose
#       run: |
#         docker-compose up -d
#         sleep 15

#     - name: Wait for backend to be ready
#       run: |
#         timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done' || true

#     - name: Test backend health endpoint
#       run: |
#         response=$(curl -s http://localhost:8080/health || echo '{"status":"error"}')
#         echo "Health response: $response"

#     - name: Test realtime API endpoint
#       run: |
#         sleep 5
#         response=$(curl -s http://localhost:8080/api/realtime || echo '[]')
#         echo "Realtime API response (first 500 chars): ${response:0:500}"

#     - name: Display container logs on failure
#       if: failure()
#       run: |
#         echo "=== Backend Logs ==="
#         docker-compose logs backend
#         echo "=== Frontend Logs ==="
#         docker-compose logs frontend

#     - name: Stop services
#       if: always()
#       run: docker-compose down -v

#   deploy-codespaces:
#     name: Verify Codespaces Compatibility
#     runs-on: ubuntu-latest
#     needs: build-and-test
    
#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Verify devcontainer configuration
#       run: |
#         if [ -f .devcontainer/devcontainer.json ]; then
#           echo "âœ… devcontainer.json found"
#           cat .devcontainer/devcontainer.json
#         else
#           echo "âš ï¸ devcontainer.json not found"
#         fi

#     - name: Validate docker-compose for Codespaces
#       run: |
#         docker-compose config > /dev/null
#         echo "âœ… docker-compose.yml is valid"

#     - name: Summary
#       run: |
#         echo "âœ… CI/CD Pipeline Complete"
#         echo "âœ… Backend builds successfully"
#         echo "âœ… Frontend builds successfully"
#         echo "âœ… Docker Compose configuration valid"
#         echo "âœ… Ready for GitHub Codespaces deployment"




# name: ESMS CI/CD Pipeline

# on:
#   push:
#     branches: [ main, develop ]
#   pull_request:
#     branches: [ main ]

# env:
#   CARGO_TERM_COLOR: always

# jobs:
#   test-backend:
#     name: Test Rust Backend
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Setup Rust
#       uses: dtolnay/rust-toolchain@stable
#       with:
#         toolchain: nightly

#     - name: Cache cargo dependencies
#       uses: actions/cache@v4
#       with:
#         path: |
#           ~/.cargo/bin/
#           ~/.cargo/registry/index/
#           ~/.cargo/registry/cache/
#           ~/.cargo/git/db/
#           backend/target/
#         key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.toml') }}

#     - name: Build backend
#       working-directory: ./backend
#       run: cargo build --verbose

#     - name: Check backend compiles
#       working-directory: ./backend
#       run: cargo check --verbose

#   build-and-test:
#     name: Build and Test Full Stack
#     runs-on: ubuntu-latest
#     needs: test-backend

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v3

#     - name: Build backend image
#       uses: docker/build-push-action@v5
#       with:
#         context: ./backend
#         file: ./backend/Dockerfile
#         push: false
#         tags: esms-backend:test
#         cache-from: type=gha
#         cache-to: type=gha,mode=max

#     - name: Build frontend image
#       uses: docker/build-push-action@v5
#       with:
#         context: ./frontend
#         file: ./frontend/Dockerfile
#         push: false
#         tags: esms-frontend:test

#     - name: Start services with Docker Compose
#       run: |
#         docker compose -f docker-compose.yml up -d
#         sleep 15

#     - name: Wait for backend to be ready
#       run: |
#         timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done' || true

#     - name: Test backend health endpoint
#       run: |
#         response=$(curl -s http://localhost:8080/health || echo '{"status":"error"}')
#         echo "Health response: $response"

#     - name: Test realtime API endpoint
#       run: |
#         sleep 5
#         response=$(curl -s http://localhost:8080/api/realtime || echo '[]')
#         echo "Realtime API response (first 500 chars): ${response:0:500}"

#     - name: Display container logs on failure
#       if: failure()
#       run: |
#         echo "=== Backend Logs ==="
#         docker compose logs backend
#         echo "=== Frontend Logs ==="
#         docker compose logs frontend
#         echo "=== Redis Logs ==="
#         docker compose logs redis
#         echo "=== MySQL Logs ==="
#         docker compose logs mysql

#     - name: Stop services
#       if: always()
#       run: docker compose down -v

#   deploy-codespaces:
#     name: Verify Codespaces Compatibility
#     runs-on: ubuntu-latest
#     needs: build-and-test

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Verify devcontainer configuration
#       run: |
#         if [ -f .devcontainer/devcontainer.json ]; then
#           echo "âœ… devcontainer.json found"
#           cat .devcontainer/devcontainer.json
#         else
#           echo "âš ï¸ devcontainer.json not found"
#         fi

#     - name: Validate docker-compose for Codespaces
#       run: |
#         docker compose -f docker-compose.yml config > /dev/null
#         echo "âœ… docker-compose.yml is valid"

#     - name: Summary
#       run: |
#         echo "âœ… CI/CD Pipeline Complete"
#         echo "âœ… Backend builds successfully"
#         echo "âœ… Frontend builds successfully"
#         echo "âœ… Docker Compose configuration valid"
#         echo "âœ… Ready for GitHub Codespaces deployment"



# name: ESMS CI/CD Pipeline

# on:
#   push:
#     branches: [ main, develop ]
#   pull_request:
#     branches: [ main ]

# env:
#   CARGO_TERM_COLOR: always

# jobs:
#   test-backend:
#     name: Test Rust Backend
#     runs-on: ubuntu-latest

#     services:
#       mysql:
#         image: mysql:8.0
#         env:
#           MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
#           MYSQL_DATABASE: esms_db
#         ports:
#           - 3306:3306
#         options: >-
#           --health-cmd "mysqladmin ping --silent"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5

#       redis:
#         image: redis:7-alpine
#         ports:
#           - 6379:6379
#         options: >-
#           --health-cmd "redis-cli ping"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Rust
#         uses: dtolnay/rust-toolchain@stable
#         with:
#           toolchain: nightly
#           override: true
#           components: rustfmt, clippy

#       - name: Cache cargo dependencies
#         uses: actions/cache@v4
#         with:
#           path: |
#             ~/.cargo/bin/
#             ~/.cargo/registry/index/
#             ~/.cargo/registry/cache/
#             ~/.cargo/git/db/
#             backend/target/
#           key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.toml') }}

#       - name: Install sqlx-cli
#         run: cargo install sqlx-cli --no-default-features --features mysql

#       - name: Setup database & run migrations
#         run: |
#           cd backend
#           sqlx database create
#           sqlx migrate run
#         env:
#           DATABASE_URL: ${{ secrets.MYSQL_DATABASE_URL }}
#           # Example secret value:
#           # mysql://root:${{ secrets.MYSQL_ROOT_PASSWORD }}@127.0.0.1:3306/esms_db

#       - name: Check backend formatting
#         working-directory: ./backend
#         run: cargo fmt -- --check

#       - name: Run clippy
#         working-directory: ./backend
#         run: cargo clippy -- -D warnings

#       - name: Run unit tests
#         working-directory: ./backend
#         run: cargo test --verbose
#         env:
#           DATABASE_URL: ${{ secrets.MYSQL_DATABASE_URL }}
#           REDIS_URL: redis://127.0.0.1:6379

#       - name: Run integration tests
#         working-directory: ./backend
#         run: cargo test --test api_integration_tests --verbose
#         env:
#           DATABASE_URL: ${{ secrets.MYSQL_DATABASE_URL }}
#           REDIS_URL: redis://127.0.0.1:6379

#   build-and-test:
#     name: Build and Test Full Stack
#     runs-on: ubuntu-latest
#     needs: test-backend

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Build backend Docker image
#         uses: docker/build-push-action@v5
#         with:
#           context: ./backend
#           file: ./backend/Dockerfile
#           push: false
#           tags: esms-backend:test
#           cache-from: type=gha
#           cache-to: type=gha,mode=max

#       - name: Build frontend Docker image
#         uses: docker/build-push-action@v5
#         with:
#           context: ./frontend
#           file: ./frontend/Dockerfile
#           push: false
#           tags: esms-frontend:test

#       - name: Start full system with Docker Compose
#         run: |
#           docker compose -f docker-compose.yml up -d
#           sleep 15

#       - name: Wait for backend to be ready
#         run: |
#           timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done' || true

#       - name: Test backend health endpoint
#         run: |
#           response=$(curl -s http://localhost:8080/health || echo '{"status":"error"}')
#           echo "Health response: $response"

#       - name: Test realtime API endpoint
#         run: |
#           sleep 5
#           response=$(curl -s http://localhost:8080/api/realtime || echo '[]')
#           echo "Realtime API response (first 500 chars): ${response:0:500}"

#       - name: Test FHIR observation endpoint
#         run: |
#           sleep 5
#           response=$(curl -s http://localhost:8080/api/fhir/observation || echo '{}')
#           echo "FHIR API response: $response"

#       - name: Display container logs on failure
#         if: failure()
#         run: |
#           echo "=== Backend Logs ==="
#           docker compose logs backend
#           echo "=== Frontend Logs ==="
#           docker compose logs frontend
#           echo "=== Redis Logs ==="
#           docker compose logs redis
#           echo "=== MySQL Logs ==="
#           docker compose logs mysql

#       - name: Stop services
#         if: always()
#         run: docker compose down -v

#   deploy-codespaces:
#     name: Verify Codespaces Compatibility
#     runs-on: ubuntu-latest
#     needs: build-and-test

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Validate devcontainer configuration
#         run: |
#           if [ -f .devcontainer/devcontainer.json ]; then
#             echo "âœ… devcontainer.json found"
#             cat .devcontainer/devcontainer.json
#           else
#             echo "âš ï¸ devcontainer.json not found"
#           fi

#       - name: Validate docker-compose for Codespaces
#         run: |
#           docker compose -f docker-compose.yml config > /dev/null
#           echo "âœ… docker-compose.yml is valid"

#       - name: Check simulation mode present
#         run: |
#           grep -q "simulate_sensor_data" backend/src/main.rs && echo "âœ… Simulation code present"

#       - name: Summary
#         run: |
#           echo "âœ… CI/CD Pipeline Complete"
#           echo "âœ… Backend builds and tests successfully"
#           echo "âœ… Frontend builds successfully"
#           echo "âœ… Docker Compose configuration valid"
#           echo "âœ… Ready for GitHub Codespaces deployment"


# name: ESMS CI/CD Pipeline

# on:
#   push:
#     branches: [ main, develop ]
#   pull_request:
#     branches: [ main ]

# # ðŸ”´ GLOBAL ENV â€” VERY IMPORTANT
# # CI must NEVER try to access serial / TCP
# env:
#   CARGO_TERM_COLOR: always
#   USE_SERIAL: "false"
#   SERIAL_TCP_HOST: "127.0.0.1"
#   SERIAL_TCP_PORT: "5555"

# jobs:
#   test-backend:
#     name: Test Rust Backend
#     runs-on: ubuntu-latest

#     services:
#       mysql:
#         image: mysql:8.0
#         env:
#           MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
#           MYSQL_DATABASE: esms_db
#         ports:
#           - 3306:3306
#         options: >-
#           --health-cmd "mysqladmin ping --silent"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5

#       redis:
#         image: redis:7-alpine
#         ports:
#           - 6379:6379
#         options: >-
#           --health-cmd "redis-cli ping"
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Install system dependencies
#         run: |
#           sudo apt-get update
#           sudo apt-get install -y pkg-config libudev-dev

#       - name: Setup Rust
#         uses: dtolnay/rust-toolchain@stable
#         with:
#           toolchain: nightly
#           override: true
#           components: rustfmt, clippy

#       - name: Cache cargo dependencies
#         uses: actions/cache@v4
#         with:
#           path: |
#             ~/.cargo/bin/
#             ~/.cargo/registry/index/
#             ~/.cargo/registry/cache/
#             ~/.cargo/git/db/
#             backend/target/
#           key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.toml') }}

#       # - name: Install sqlx-cli
#       #   run: cargo install sqlx-cli --no-default-features --features mysql
      

#       - name: Install sqlx-cli if missing
#         run: |
#           if ! command -v sqlx &> /dev/null; then
#             cargo install sqlx-cli --no-default-features --features mysql
#           else
#             echo "sqlx already installed"
#           fi


#       - name: Setup database & run migrations
#         run: |
#           cd backend
#           sqlx database create
#           sqlx migrate run
#         env:
#           DATABASE_URL: ${{ secrets.MYSQL_DATABASE_URL }}

#       - name: Check backend formatting
#         working-directory: ./backend
#         run: cargo fmt -- --check

#       - name: Run clippy
#         working-directory: ./backend
#         run: cargo clippy -- -D warnings

#       - name: Run unit tests
#         working-directory: ./backend
#         run: cargo test --verbose
#         env:
#           DATABASE_URL: ${{ secrets.MYSQL_DATABASE_URL }}
#           REDIS_URL: redis://127.0.0.1:6379
#           USE_SERIAL: "false"   # ðŸ”´ explicit safety

#       - name: Run integration tests
#         working-directory: ./backend
#         run: cargo test --test api_integration_tests --verbose
#         env:
#           DATABASE_URL: ${{ secrets.MYSQL_DATABASE_URL }}
#           REDIS_URL: redis://127.0.0.1:6379
#           USE_SERIAL: "false"   # ðŸ”´ explicit safety

#   build-and-test:
#     name: Build and Test Full Stack
#     runs-on: ubuntu-latest
#     needs: test-backend

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Build backend Docker image
#         uses: docker/build-push-action@v5
#         with:
#           context: ./backend
#           file: ./backend/Dockerfile
#           push: false
#           tags: esms-backend:test
#           cache-from: type=gha
#           cache-to: type=gha,mode=max

#       - name: Build frontend Docker image
#         uses: docker/build-push-action@v5
#         with:
#           context: ./frontend
#           file: ./frontend/Dockerfile
#           push: false
#           tags: esms-frontend:test

#       # ðŸ”´ SERIAL DISABLED AT COMPOSE LEVEL
#       - name: Start full system with Docker Compose
#         run: |
#           USE_SERIAL=false docker compose -f docker-compose.yml up -d
#           sleep 15

#       - name: Wait for backend to be ready
#         run: |
#           timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done' || true

#       - name: Test backend health endpoint
#         run: |
#           response=$(curl -s http://localhost:8080/health || echo '{"status":"error"}')
#           echo "Health response: $response"

#       - name: Test realtime API endpoint
#         run: |
#           sleep 5
#           response=$(curl -s http://localhost:8080/api/realtime || echo '[]')
#           echo "Realtime API response (first 500 chars): ${response:0:500}"

#       - name: Test FHIR observation endpoint
#         run: |
#           sleep 5
#           response=$(curl -s http://localhost:8080/api/fhir/observation || echo '{}')
#           echo "FHIR API response: $response"

#       - name: Display container logs on failure
#         if: failure()
#         run: |
#           echo "=== Backend Logs ==="
#           docker compose logs backend
#           echo "=== Frontend Logs ==="
#           docker compose logs frontend
#           echo "=== Redis Logs ==="
#           docker compose logs redis
#           echo "=== MySQL Logs ==="
#           docker compose logs mysql

#       - name: Stop services
#         if: always()
#         run: docker compose down -v

#   deploy-codespaces:
#     name: Verify Codespaces Compatibility
#     runs-on: ubuntu-latest
#     needs: build-and-test

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Validate devcontainer configuration
#         run: |
#           if [ -f .devcontainer/devcontainer.json ]; then
#             echo "âœ… devcontainer.json found"
#             cat .devcontainer/devcontainer.json
#           else
#             echo "âš ï¸ devcontainer.json not found"
#           fi

#       - name: Validate docker-compose for Codespaces
#         run: |
#           docker compose -f docker-compose.yml config > /dev/null
#           echo "âœ… docker-compose.yml is valid"

#       - name: Check simulation mode present
#         run: |
#           grep -q "simulate_sensor_data" backend/src/main.rs && echo "âœ… Simulation code present"

#       - name: Summary
#         run: |
#           echo "âœ… CI/CD Pipeline Complete"
#           echo "âœ… Backend builds and tests successfully"
#           echo "âœ… Frontend builds successfully"
#           echo "âœ… Docker Compose configuration valid"
#           echo "âœ… Ready for GitHub Codespaces deployment"




# name: ESMS CI/CD Pipeline

# on:
#   push:
#     branches: [ main, develop ]
#   pull_request:
#     branches: [ main ]

# env:
#   CARGO_TERM_COLOR: always

# jobs:
#   test-backend:
#     name: Test Rust Backend
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Setup Rust
#       uses: dtolnay/rust-toolchain@stable
#       with:
#         toolchain: nightly

#     - name: Cache cargo dependencies
#       uses: actions/cache@v4
#       with:
#         path: |
#           ~/.cargo/bin/
#           ~/.cargo/registry/index/
#           ~/.cargo/registry/cache/
#           ~/.cargo/git/db/
#           backend/target/
#         key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.toml') }}

#     - name: Build backend
#       working-directory: ./backend
#       run: cargo build --verbose

#     - name: Check backend compiles
#       working-directory: ./backend
#       run: cargo check --verbose

#   build-and-test:
#     name: Build and Test Full Stack
#     runs-on: ubuntu-latest
#     needs: test-backend

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v3

#     - name: Build backend image
#       uses: docker/build-push-action@v5
#       with:
#         context: ./backend
#         file: ./backend/Dockerfile
#         push: false
#         tags: esms-backend:test
#         cache-from: type=gha
#         cache-to: type=gha,mode=max

#     - name: Build frontend image
#       uses: docker/build-push-action@v5
#       with:
#         context: ./frontend
#         file: ./frontend/Dockerfile
#         push: false
#         tags: esms-frontend:test

#     - name: Start services with Docker Compose
#       run: |
#         docker compose -f docker-compose.yml up -d
#         sleep 15
#     - name: Wait for backend to be ready
#       run: |
#         timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done' || true
#     - name: Test backend health endpoint
#       run: |
#         response=$(curl -s http://localhost:8080/health || echo '{"status":"error"}')
#         echo "Health response: $response"
#     - name: Test realtime API endpoint
#       run: |
#         sleep 5
#         response=$(curl -s http://localhost:8080/api/realtime || echo '[]')
#         echo "Realtime API response (first 500 chars): ${response:0:500}"
#     - name: Display container logs on failure
#       if: failure()
#       run: |
#         echo "=== Backend Logs ==="
#         docker compose logs backend
#         echo "=== Frontend Logs ==="
#         docker compose logs frontend
#         echo "=== Redis Logs ==="
#         docker compose logs redis
#         echo "=== MySQL Logs ==="
#         docker compose logs mysql
#     - name: Stop services
#       if: always()
#       run: docker compose down -v

#   deploy-codespaces:
#     name: Verify Codespaces Compatibility
#     runs-on: ubuntu-latest
#     needs: build-and-test

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Verify devcontainer configuration
#       run: |
#         if [ -f .devcontainer/devcontainer.json ]; then
#           echo "âœ… devcontainer.json found"
#           cat .devcontainer/devcontainer.json
#         else
#           echo "âš ï¸ devcontainer.json not found"
#         fi
#     - name: Validate docker-compose for Codespaces
#       run: |
#         docker compose -f docker-compose.yml config > /dev/null
#         echo "âœ… docker-compose.yml is valid"
#     - name: Summary
#       run: |
#         echo "âœ… CI/CD Pipeline Complete"
#         echo "âœ… Backend builds successfully"
#         echo "âœ… Frontend builds successfully"
#         echo "âœ… Docker Compose configuration valid"
#         echo "âœ… Ready for GitHub Codespaces deployment"



name: ESMS CI

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file for CI
        run: |
          cat <<EOF > .env
          MYSQL_DATABASE_URL=mysql://esms_user:esms_pass@mysql:3306/esms_db
          REDIS_URL=redis://redis:6379
          USE_SERIAL=false
          RUST_LOG=info
          EOF

      - name: Verify docker-compose config
        run: docker compose config

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.lock') }}


      - name: Validate docker-compose file
        run: docker compose config

      - name: Build Docker images
        run: docker compose build

      - name: Start containers
        run: docker compose up -d

      - name: Wait for services
        run: sleep 20

      - name: Show running containers
        run: docker ps

      - name: Stop containers
        run: docker compose down
